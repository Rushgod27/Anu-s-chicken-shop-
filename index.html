<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Anu‚Äôs Chicken Shop ‚Äì Billing</title>

<style>
html,body{margin:0;padding:0;font-family:system-ui;background:#f1f5f9}
*{box-sizing:border-box}

.header{
  background:linear-gradient(135deg,#fbbf24,#f59e0b);
  padding:14px;font-size:26px;font-weight:900;text-align:center
}

.container{max-width:1400px;margin:auto;padding:10px}
.main{display:grid;grid-template-columns:1fr 420px;gap:14px}

.card{
  background:#fff;border-radius:18px;padding:14px;margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.05)
}

.row{display:flex;gap:10px;margin-bottom:10px}
input{width:100%;padding:14px;font-size:18px;border-radius:14px;border:1px solid #cbd5f5}

.btn{flex:1;padding:14px;font-size:16px;font-weight:800;border:none;border-radius:14px;background:#e5e7eb}
.btn.active{background:#fbbf24}

.primary{
  width:100%;padding:18px;font-size:22px;font-weight:900;border:none;
  border-radius:16px;background:#4f46e5;color:#fff
}

.total{
  background:#dbeafe;font-size:26px;font-weight:900;
  padding:14px;border-radius:16px;text-align:center
}

.return{background:#dcfce7;font-size:18px;font-weight:900;padding:12px;border-radius:14px}
.return.negative{background:#fee2e2;color:#991b1b}

.keypad-wrap{position:sticky;top:10px;height:80vh}
.keypad{
  background:#111827;border-radius:26px;padding:16px;
  display:grid;grid-template-columns:repeat(3,1fr);gap:14px
}
.keypad button{
  font-size:30px;font-weight:900;border:none;border-radius:20px;
  background:#374151;color:#fff
}
.keypad .del{background:#ef4444}
</style>
</head>

<body>

<div class="header">üêî Anu‚Äôs Chicken Shop ‚Äì Billing</div>

<div class="container">
<div class="main">

<div>

<!-- PRICES -->
<div class="card">
<h3>Today‚Äôs Prices</h3>
<div class="row">
<input id="broilerPrice" placeholder="Broiler ‚Çπ/kg">
<input id="countryPrice" placeholder="Country ‚Çπ/kg">
<input id="eggPrice" placeholder="Egg ‚Çπ">
</div>
<button class="primary" onclick="savePrices()">Save Prices</button>
</div>

<!-- ITEMS -->
<div class="card">
<h3>Add Items</h3>
<div class="row">
<button class="btn" onclick="toggleItem('broiler',this)">Broiler</button>
<button class="btn" onclick="toggleItem('country',this)">Country</button>
<button class="btn" onclick="toggleItem('egg',this)">Eggs</button>
<button class="btn" onclick="toggleItem('masala',this)">Masala</button>
</div>
</div>

<div class="card" id="broilerBox" style="display:none">
<h3>Broiler</h3>
<div class="row">
<button class="btn" onclick="setMode('broiler','kg',this)">KG</button>
<button class="btn" onclick="setMode('broiler','rs',this)">‚Çπ</button>
</div>
<input id="broilerKg" placeholder="KG">
<input id="broilerRs" placeholder="Amount ‚Çπ" style="display:none">
</div>

<div class="card" id="countryBox" style="display:none">
<h3>Country</h3>
<div class="row">
<button class="btn" onclick="setMode('country','kg',this)">KG</button>
<button class="btn" onclick="setMode('country','rs',this)">‚Çπ</button>
</div>
<input id="countryKg" placeholder="KG">
<input id="countryRs" placeholder="Amount ‚Çπ" style="display:none">
</div>

<div class="card" id="eggBox" style="display:none">
<h3>Eggs</h3>
<input id="eggQty" placeholder="Quantity">
</div>

<div class="card" id="masalaBox" style="display:none">
<h3>Masala</h3>
<input id="masalaAmt" placeholder="Amount ‚Çπ">
</div>

<div class="card">
<h3>Payment</h3>
<div class="row">
<button class="btn" onclick="setPayment('cash',this)">Cash</button>
<button class="btn" onclick="setPayment('online',this)">Online</button>
</div>
<input id="received" placeholder="Received ‚Çπ" style="display:none">
<div id="returnBox" class="return" style="display:none">
Return ‚Çπ <span id="returnAmt">0.00</span>
</div>
</div>

<div class="card">
<div class="total">TOTAL ‚Çπ <span id="total">0.00</span></div>
<button class="primary" onclick="confirmSale()">SALE</button>
</div>

</div>

<div class="keypad-wrap">
<div class="keypad">
<button onclick="add('7')">7</button>
<button onclick="add('8')">8</button>
<button onclick="add('9')">9</button>
<button onclick="add('4')">4</button>
<button onclick="add('5')">5</button>
<button onclick="add('6')">6</button>
<button onclick="add('1')">1</button>
<button onclick="add('2')">2</button>
<button onclick="add('3')">3</button>
<button onclick="add('0')">0</button>
<button onclick="add('.')">.</button>
<button class="del" onclick="del()">‚å´</button>
</div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, where,
  orderBy, limit, getDocs, serverTimestamp,
  doc, getDoc, setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
  apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
  authDomain:"anus-chicken-shop.firebaseapp.com",
  projectId:"anus-chicken-shop"
});

const db=getFirestore();
const today=new Date().toISOString().slice(0,10);

let activeInput=null,payment=null;
let active={broiler:false,country:false,egg:false,masala:false};
let mode={broiler:"kg",country:"kg"};

document.querySelectorAll("input").forEach(i=>i.onclick=()=>activeInput=i);
window.add=v=>{if(activeInput){activeInput.value+=v;calc()}};
window.del=()=>{if(activeInput){activeInput.value=activeInput.value.slice(0,-1);calc()}};

window.toggleItem=(t,b)=>{
  active[t]=!active[t];
  b.classList.toggle("active");
  document.getElementById(t+"Box").style.display=active[t]?"block":"none";
  calc();
};

window.setMode=(t,m,b)=>{
  mode[t]=m;
  b.parentElement.querySelectorAll(".btn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  document.getElementById(t+"Kg").style.display=m==="kg"?"block":"none";
  document.getElementById(t+"Rs").style.display=m==="rs"?"block":"none";
};

window.setPayment=(p,b)=>{
  payment=p;
  b.parentElement.querySelectorAll(".btn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  received.style.display=p==="cash"?"block":"none";
  returnBox.style.display=p==="cash"?"block":"none";
};

function calc(){
  let t=0;
  if(active.broiler)t+=(mode.broiler==="kg"?+broilerKg.value:(+broilerRs.value/+broilerPrice.value||0))*+broilerPrice.value;
  if(active.country)t+=(mode.country==="kg"?+countryKg.value:(+countryRs.value/+countryPrice.value||0))*+countryPrice.value;
  if(active.egg)t+=(+eggQty.value||0)*(+eggPrice.value||0);
  if(active.masala)t+=(+masalaAmt.value||0);
  total.innerText=t.toFixed(2);

  if(payment==="cash"){
    const r=(+received.value||0)-t;
    returnAmt.innerText=r.toFixed(2);
    returnBox.classList.toggle("negative",r<0);
  }
}

/* SAVE + LOAD PRICES */
window.savePrices=async()=>{
  await addDoc(collection(db,"dailyPrices"),{
    date:today,
    broilerPrice:+broilerPrice.value,
    countryPrice:+countryPrice.value,
    eggPrice:+eggPrice.value,
    updatedAt:serverTimestamp(),
    updatedAtMs:Date.now()
  });
  alert("Prices saved");
};

(async()=>{
  const q=query(collection(db,"dailyPrices"),
    where("date","==",today),
    orderBy("updatedAtMs","desc"),
    limit(1));
  const s=await getDocs(q);
  if(!s.empty){
    const d=s.docs[0].data();
    broilerPrice.value=d.broilerPrice;
    countryPrice.value=d.countryPrice;
    eggPrice.value=d.eggPrice;
  }
})();

/* üî• CORRECT DEDUCTION (EGGS + MASALA FIXED) */
async function deductLive(items){
  const ref=doc(db,"stock_current","live");
  const snap=await getDoc(ref);
  let s=snap.exists()?snap.data():{};

  s.broiler ??= {availableKg:0,soldKg:0};
  s.country ??= {availableKg:0,soldKg:0};
  s.eggs ??= {available:0,sold:0};
  s.masala ??= {availableAmount:0,soldAmount:0};

  if(items.broiler){s.broiler.availableKg-=items.broiler.qty;s.broiler.soldKg+=items.broiler.qty;}
  if(items.country){s.country.availableKg-=items.country.qty;s.country.soldKg+=items.country.qty;}
  if(items.eggs){s.eggs.available-=items.eggs.qty;s.eggs.sold+=items.eggs.qty;}
  if(items.masala){s.masala.availableAmount-=items.masala.amount;s.masala.soldAmount+=items.masala.amount;}

  await setDoc(ref,{...s,updatedAt:serverTimestamp()},{merge:true});
}

/* FIFO */
async function consumeFIFO(type,qty){
  let r=qty,c=0;
  const q=query(collection(db,"stock"),where("type","==",type),where("status","==","active"),orderBy("createdAt"));
  const snap=await getDocs(q);
  for(const d of snap.docs){
    if(r<=0)break;
    const b=d.data();
    const take=Math.min(b.remainingKg,r);
    r-=take;c+=take*b.costPerSellableKg;
    await updateDoc(d.ref,take>=b.remainingKg?{remainingKg:0,status:"closed"}:{remainingKg:b.remainingKg-take});
  }
  if(r>0)throw new Error("Insufficient "+type);
  return +c.toFixed(2);
}

/* SALE */
window.confirmSale=async()=>{
  let items={};

  if(active.broiler){items.broiler={qty:mode.broiler==="kg"?+broilerKg.value:(+broilerRs.value/+broilerPrice.value)};await consumeFIFO("broiler",items.broiler.qty)}
  if(active.country){items.country={qty:mode.country==="kg"?+countryKg.value:(+countryRs.value/+countryPrice.value)};await consumeFIFO("country",items.country.qty)}
  if(active.egg&&+eggQty.value>0)items.eggs={qty:+eggQty.value}
  if(active.masala&&+masalaAmt.value>0)items.masala={amount:+masalaAmt.value}

  await addDoc(collection(db,"sales"),{date:today,items,total:+total.innerText,payment,createdAt:serverTimestamp()});
  await deductLive(items);
  alert("Sale saved");location.reload();
};
</script>

</body>
</html>
